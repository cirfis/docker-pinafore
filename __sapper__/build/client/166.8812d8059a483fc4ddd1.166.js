(this.webpackChunkpinafore=this.webpackChunkpinafore||[]).push([[166],{166:(t,e,n)=>{"use strict";n.r(e),n.d(e,{DELETE_AFTER:()=>de,clearDatabaseForInstance:()=>rt,closeKeyValIDBConnection:()=>ue,deleteCachedMediaFile:()=>pe,deleteStatusesAndNotifications:()=>Tt,deleteWebShareData:()=>ae,getAccount:()=>ot,getAllCachedFileIds:()=>be,getCachedMediaFile:()=>we,getCustomEmoji:()=>Qt,getFilters:()=>ee,getFollowRequestCount:()=>Yt,getInstanceInfo:()=>Ht,getInstanceVerifyCredentials:()=>$t,getLists:()=>Gt,getNotification:()=>jt,getNotificationIdsForStatuses:()=>ut,getPinnedStatuses:()=>Et,getReblogsForStatus:()=>it,getRelationship:()=>se,getStatus:()=>Ft,getTimeline:()=>zt,getWebShareData:()=>ie,insertPinnedStatuses:()=>At,insertStatus:()=>Bt,insertTimelineItems:()=>Dt,searchAccountsByUsername:()=>at,setAccount:()=>ct,setCachedMediaFile:()=>me,setCustomEmoji:()=>Xt,setDeleteCachedMediaFilesAfter:()=>_e,setFilters:()=>ne,setFollowRequestCount:()=>te,setInstanceInfo:()=>Ut,setInstanceVerifyCredentials:()=>Zt,setLists:()=>Jt,setRelationship:()=>oe,setStatusBookmarked:()=>Wt,setStatusFavorited:()=>Nt,setStatusMuted:()=>Ot,setStatusPinned:()=>Mt,setStatusReblogged:()=>Lt,setWebShareData:()=>re});const s="statuses-v4",o="status_timelines-v4",c="meta-v4",a="accounts-v4",r="relationships-v4",i="notifications-v4",u="notification_timelines-v4",l="pinned_statuses-v4",f="threads-v4",d="__pinafore_ts",h="__pinafore_acct_id",g="__pinafore_status_id",y="__pinafore_reblog_id",w="__pinafore_acct_lc",m=12,p=()=>Date.now();var b=n(4986);const _={maxSize:100,caches:{}},S={maxSize:50,caches:{}},I={maxSize:20,caches:{}},C={maxSize:20,caches:{}},v={maxSize:50,caches:{}};function D(t,e){let n=t.caches[e];return n||(n=t.caches[e]=new b.c({maxSize:t.maxSize})),n}function B(t,e){delete t.caches[e]}function x(t){const e=[_,S,I,C,v];for(const n of e)B(n,t)}function k(t,e,n,s){return D(t,e).set(n,s)}function A(t,e,n){return D(t,e).get(n)}function E(t,e,n){return D(t,e).has(n)}function K(t,e,n){D(t,e).delete(n)}var R=n(673);class z{constructor(t="keyval-store",e="keyval"){this.storeName=e,this._dbName=t,this._storeName=e,this._init()}_withIDBStore(t,e){return this._init(),this._dbp.then((n=>new Promise(((s,o)=>{const c=n.transaction(this.storeName,t);c.oncomplete=()=>s(),c.onabort=c.onerror=()=>o(c.error),e(c.objectStore(this.storeName))}))))}_init(){this._dbp||(this._dbp=new Promise(((t,e)=>{const n=indexedDB.open(this._dbName,1);n.onerror=()=>e(n.error),n.onsuccess=()=>t(n.result),n.onupgradeneeded=()=>{n.result.createObjectStore(this._storeName)}})))}_close(){return this._init(),this._dbp.then((t=>{t.close(),this._dbp=void 0}))}}let F;function j(){return F||(F=new z),F}function P(t){let e;return j()._withIDBStore("readonly",(n=>{e=n.get(t)})).then((()=>e.result))}function N(t,e){return j()._withIDBStore("readwrite",(n=>{n.put(e,t)}))}function L(t){return j()._withIDBStore("readwrite",(e=>{e.delete(t)}))}function M(){const t=j(),e=[];return t._withIDBStore("readonly",(t=>{(t.openKeyCursor||t.openCursor).call(t).onsuccess=function(){this.result&&(e.push(this.result.key),this.result.continue())}})).then((()=>e))}function O(){return j()._close()}R.S.addEventListener("statechange",(async t=>{"frozen"===t.newState&&await O()}));const W="known-instance-";var T=n(137);const q=[{version:9,migration:function(t,e,n){function h(e,n,s){const o=n?t.createObjectStore(e,n):t.createObjectStore(e);s&&Object.keys(s).forEach((t=>{o.createIndex(t,s[t])}))}h(s,{keyPath:"id"},{[d]:d,[y]:y}),h(o,null,{statusId:""}),h(i,{keyPath:"id"},{[d]:d,[g]:g}),h(u,null,{notificationId:""}),h(a,{keyPath:"id"},{[d]:d}),h(r,{keyPath:"id"},{[d]:d}),h(f,null,{statusId:""}),h(l,null,{statusId:""}),h(c),n()}},{version:10,migration:function(t,e,n){e.objectStore(a).createIndex(w,w),n()}},{version:12,migration:function(t,e,n){const s=[o,u];let c=0;s.forEach((t=>{const o=e.objectStore(t);o.openCursor().onsuccess=t=>{const{result:e}=t.target;if(e){const{key:t,value:n}=e,s=t.split("\0")[0]+"\0"+(0,T.hC)(n);o.delete(t).onsuccess=()=>{o.add(n,s).onsuccess=()=>{e.continue()}}}else++c===s.length&&n()}}))}}];var V=n(2846);const $={},Z={};async function H(t){if(!t)throw new Error("instanceName is undefined in getDatabase()");return Z[t]||(Z[t]=await function(t){return new Promise(((e,n)=>{const s=indexedDB.open(t,m);$[t]=s,s.onerror=n,s.onblocked=()=>{console.error("idb blocked")},s.onupgradeneeded=t=>{const e=s.result,n=t.currentTarget.transaction,o=q.filter((({version:e})=>t.oldVersion<e));!function t(){if(!o.length)return;const{migration:s}=o.shift();s(e,n,t)}()},s.onsuccess=()=>e(s.result)}))}(t),await async function(t){return N(W+t,!0)}(t)),Z[t]}async function U(t,e,n,s){return new Promise(((o,c)=>{const a=t.transaction(e,n),r="string"==typeof e?a.objectStore(e):e.map((t=>a.objectStore(t)));let i;s(r,(t=>{i=t})),a.oncomplete=()=>o(i),a.onerror=()=>c(a.error)}))}function G(t){return new Promise(((e,n)=>{const s=$[t];s&&s.result&&s.result.close(),delete $[t],delete Z[t];const o=indexedDB.deleteDatabase(t);o.onsuccess=()=>e(),o.onerror=()=>n(o.error),o.onblocked=()=>console.error(`database ${t} blocked`)})).then((()=>async function(t){return L(W+t)}(t))).then((()=>x(t)))}async function J(t,e,n,s){if(E(e,n,s))return A(e,n,s);const o=await H(n),c=await U(o,t,"readonly",((t,e)=>{t.get(s).onsuccess=t=>e(t.target.result)}));return k(e,n,s,c),c}async function Q(t,e,n,s){k(e,n,s.id,s);return U(await H(n),t,"readwrite",(t=>{t.put(s)}))}function X(t){const e={},n=Object.keys(t);for(const s of n){const n=t[s];if(n&&(!Array.isArray(n)||0!==n.length))switch(s){case"account":e[h]=n.id;break;case"status":e[g]=n.id;break;case"reblog":e[y]=n.id;break;case"acct":e[s]=n,e.__pinafore_acct_lc=n.toLowerCase();break;default:e[s]=n}}return e[d]=p(),e}function Y(t,e){return t+"\0"+(0,T.hC)(e)}function tt(t,e){const n=e&&(0,T.hC)(e),s=n?t+"\0"+n:t+"\0",o=t+"\0￿";return IDBKeyRange.bound(s,o,!0,!0)}function et(t,e){return t+"\0"+(0,T.Bu)(e,5)}function nt(t){return IDBKeyRange.bound(t+"\0",t+"\0￿")}function st(t){return IDBKeyRange.bound(t+"\0",t+"\0￿")}async function ot(t,e){return J(a,S,t,e)}async function ct(t,e){return Q(a,S,t,X(e))}async function at(t,e,n){n=n||20;return U(await H(t),a,"readonly",((t,s)=>{const o=(c=e.toLowerCase(),IDBKeyRange.bound(c,c+"￿"));var c;t.index(w).getAll(o,n).onsuccess=t=>{s(t.target.result)}}))}async function rt(t){B(_,t),B(S,t),B(C,t),await G(t)}async function it(t,e){const n=await H(t);await U(n,s,"readonly",((t,n)=>{t.index(y).getAll(IDBKeyRange.only(e)).onsuccess=t=>{n(t.target.result)}}))}async function ut(t,e){return U(await H(t),i,"readonly",((t,n)=>{const s=[];n(s),e.forEach((e=>{t.index(g).getAllKeys(IDBKeyRange.only(e)).onsuccess=t=>{for(const e of t.target.result)s.push(e)}}))}))}function lt(t,e){k(_,e,t.id,t),k(S,e,t.account.id,t.account),t.reblog&&k(S,e,t.reblog.account.id,t.reblog.account)}R.S.addEventListener("statechange",(t=>{"frozen"===t.newState&&Object.keys($).forEach((t=>{!function(t){const e=$[t];e&&e.result&&e.result.close(),delete $[t],delete Z[t],x(t)}(t)}))})),(0,V.F)((()=>L("./eng.traineddata")));var ft=n(3562),dt=n(9269),ht=n(624),gt=n(7569);function yt(t,e,n){e.getAllKeys(n).onsuccess=e=>{for(const n of e.target.result)t.delete(n)}}var wt=n(8513);function mt(t,e){!function n(){t().onsuccess=function(t){const s=t.target.result;e(s),s.length&&n()}}()}async function pt(t){(0,gt.B)(`cleanup:${t}`);const e=await H(t),n=[s,o,i,u,a,r,f,l];await U(e,n,"readwrite",(t=>{const[e,n,s,o,c,a,r,i]=t,u=Date.now()-wt.f;!function(t,e,n,s){mt((()=>t.index(d).getAllKeys(IDBKeyRange.upperBound(s),20)),(s=>{s.forEach((s=>{t.delete(s),yt(e,e.index("statusId"),IDBKeyRange.only(s)),yt(n,n,nt(s))}))}))}(e,n,r,u),function(t,e,n){mt((()=>t.index(d).getAllKeys(IDBKeyRange.upperBound(n),20)),(n=>{n.forEach((n=>{t.delete(n),yt(e,e.index("notificationId"),IDBKeyRange.only(n))}))}))}(s,o,u),function(t,e,n){mt((()=>t.index(d).getAllKeys(IDBKeyRange.upperBound(n),20)),(n=>{n.forEach((n=>{t.delete(n),yt(e,e,st(n))}))}))}(c,i,u),function(t,e){mt((()=>t.index(d).getAllKeys(IDBKeyRange.upperBound(e),20)),(e=>{e.forEach((e=>{t.delete(e)}))}))}(a,u)})),(0,gt.s)(`cleanup:${t}`)}function bt(t){(0,V.F)((()=>pt(t)))}const _t=(0,ht.Z)((async function(){const t=await async function(){return(await M()).filter((t=>t.startsWith(W))).map((t=>t.substring(W.length)))}();for(const e of t)bt(e)}),wt.P);function St(t,e){t.put(X(e))}function It(t,e){t.put(X(e))}function Ct(t,e,n){St(t,n),It(e,n.account),n.reblog&&(St(t,n.reblog),It(e,n.reblog.account))}function vt(t,e,n,s){s.status&&Ct(e,n,s.status),function(t,e){It(t,e)}(n,s.account),function(t,e){t.put(X(e))}(t,s)}async function Dt(t,e,n){if(_t(),"notifications"===e||"notifications/mentions"===e)return async function(t,e,n){for(const s of n)k(v,t,s.id,s),k(S,t,s.account.id,s.account),s.status&&k(_,t,s.status.id,s.status);const o=await H(t),c=[u,i,a,s];await U(o,c,"readwrite",(t=>{const[s,o,c,a]=t;for(const r of n)vt(o,a,c,r),s.put(r.id,Y(e,r.id))}))}(t,e,n);if(e.startsWith("status/")){return async function(t,e,n){for(const s of n)lt(s,t);const o=await H(t),c=[f,s,a];await U(o,c,"readwrite",(t=>{const[s,o,c]=t;s.getAllKeys(nt(e)).onsuccess=t=>{const o=t.target.result,c=(0,dt.Z)(n.length,(t=>et(e,t))),a=(0,ft.Z)(o,c);for(const e of a)s.delete(e)},n.forEach(((t,n)=>{Ct(o,c,t),s.put(t.id,et(e,n))}))}))}(t,e.split("/").slice(-1)[0],n)}return async function(t,e,n){for(const s of n)lt(s,t);const c=await H(t),r=[o,s,a];await U(c,r,"readwrite",(t=>{const[s,o,c]=t;for(const a of n)Ct(o,c,a),s.put(a.id,Y(e,a.id))}))}(t,e,n)}async function Bt(t,e){lt(e,t);const n=await H(t);await U(n,[s,a],"readwrite",(([t,n])=>{Ct(t,n,e)}))}function xt(t,e,n){t.get(e).onsuccess=t=>{n(t.target.result)}}function kt(t,e,n,s){t.get(n).onsuccess=n=>{const o=n.target.result;s(o),o&&(xt(e,o[h],(t=>{o.account=t})),o[y]&&kt(t,e,o[y],(t=>{o.reblog=t})))}}async function At(t,e,n){for(const s of n)lt(s,t);const o=await H(t),c=[l,s,a];await U(o,c,"readwrite",(t=>{const[s,o,c]=t,a=st(e);s.getAll(a).onsuccess=t=>{const a=t.target.result;for(let o=n.length;o<a.length;o++)s.delete(st(e));n.forEach(((t,n)=>{Ct(o,c,t),s.put(t.id,function(t,e){return t+"\0"+(0,T.Bu)(e,3)}(e,n))}))}}))}async function Et(t,e){const n=[l,s,a];return U(await H(t),n,"readonly",((t,n)=>{const[s,o,c]=t,a=st(e);s.getAll(a).onsuccess=t=>{const e=t.target.result,s=new Array(e.length);e.forEach(((t,e)=>{kt(o,c,t,(t=>{s[e]=t}))})),n(s)}}))}function Kt(t,e,n,s,o){t.get(s).onsuccess=t=>{const s=t.target.result;o(s),xt(n,s[h],(t=>{s.account=t})),s[g]&&kt(e,n,s[g],(t=>{s.status=t}))}}var Rt=n(2961);async function zt(t,e,n,c){if(n=n||null,c=c||Rt.L,"notifications"===e||"notifications/mentions"===e)return async function(t,e,n,o){const c=[u,i,s,a];return U(await H(t),c,"readonly",((t,s)=>{const[c,a,r,i]=t,u=tt(e,n);c.getAll(u,o).onsuccess=t=>{const e=t.target.result,n=new Array(e.length);e.forEach(((t,e)=>{Kt(a,r,i,t,(t=>{n[e]=t}))})),s(n)}}))}(t,e,n,c);if(e.startsWith("status/")){return async function(t,e){const n=[f,s,a];return U(await H(t),n,"readonly",((t,n)=>{const[s,o,c]=t,a=nt(e);s.getAll(a).onsuccess=t=>{const s=t.target.result;if(s.length){const t=new Array(s.length);n(t),s.forEach(((e,n)=>{kt(o,c,e,(e=>{t[n]=e}))}))}else kt(o,c,e,(t=>{n([t])}))}}))}(t,e.split("/").slice(-1)[0])}return async function(t,e,n,c){const r=[o,s,a];return U(await H(t),r,"readonly",((t,s)=>{const[o,a,r]=t;o.getAll(tt(e,n),c).onsuccess=t=>{const e=t.target.result,n=new Array(e.length);e.forEach(((t,e)=>{kt(a,r,t,(t=>{n[e]=t}))})),s(n)}}))}(t,e,n,c)}async function Ft(t,e){if(E(_,t,e))return A(_,t,e);const n=await H(t),o=[s,a],c=await U(n,o,"readonly",((t,n)=>{const[s,o]=t;kt(s,o,e,n)}));return k(_,t,e,c),c}async function jt(t,e){if(E(v,t,e))return A(v,t,e);const n=await H(t),o=[i,s,a],c=await U(n,o,"readonly",((t,n)=>{const[s,o,c]=t;Kt(s,o,c,e,n)}));return k(v,t,e,c),c}async function Pt(t,e,n){const o=await H(t);if(E(_,t,e)){const s=A(_,t,e);n(s),lt(s,t)}return U(o,s,"readwrite",(t=>{t.get(e).onsuccess=e=>{const s=e.target.result;n(s),St(t,s)}}))}async function Nt(t,e,n){return Pt(t,e,(t=>{const e=(n?1:0)-(t.favourited?1:0);t.favourited=n,t.favourites_count=(t.favourites_count||0)+e}))}async function Lt(t,e,n){return Pt(t,e,(t=>{const e=(n?1:0)-(t.reblogged?1:0);t.reblogged=n,t.reblogs_count=(t.reblogs_count||0)+e}))}async function Mt(t,e,n){return Pt(t,e,(t=>{t.pinned=n}))}async function Ot(t,e,n){return Pt(t,e,(t=>{t.muted=n}))}async function Wt(t,e,n){return Pt(t,e,(t=>{t.bookmarked=n}))}async function Tt(t,e,n){for(const s of e)K(_,t,s);for(const s of n)K(v,t,s);const c=await H(t),a=[s,o,i,u,l,f];await U(c,a,"readwrite",(t=>{const[s,o,c,a,r,i]=t;function u(t){s.delete(t),yt(r,r.index("statusId"),IDBKeyRange.only(t)),yt(o,o.index("statusId"),IDBKeyRange.only(t)),yt(i,i.index("statusId"),IDBKeyRange.only(t)),yt(i,i,nt(t))}function l(t){c.delete(t),yt(a,a.index("notificationId"),IDBKeyRange.only(t))}for(const n of e)u(n);for(const e of n)l(e)}))}async function qt(t,e){if(E(C,t,e))return A(C,t,e);const n=await H(t),s=await U(n,c,"readonly",((t,n)=>{t.get(e).onsuccess=t=>{n(t.target.result)}}));return k(C,t,e,s),s}async function Vt(t,e,n){k(C,t,e,n);return U(await H(t),c,"readwrite",(t=>{t.put(n,e)}))}async function $t(t){return qt(t,"verifyCredentials")}async function Zt(t,e){return Vt(t,"verifyCredentials",e)}async function Ht(t){return qt(t,"instance")}async function Ut(t,e){return Vt(t,"instance",e)}async function Gt(t){return qt(t,"lists")}async function Jt(t,e){return Vt(t,"lists",e)}async function Qt(t){return qt(t,"customEmoji")}async function Xt(t,e){return Vt(t,"customEmoji",e)}async function Yt(t){return qt(t,"followRequestCount")}async function te(t,e){return Vt(t,"followRequestCount",e)}async function ee(t){return qt(t,"filters")}async function ne(t,e){return Vt(t,"filters",e)}async function se(t,e){return J(r,I,t,e)}async function oe(t,e){return Q(r,I,t,X(e))}const ce="web-share-data";function ae(){return L(ce)}function re(t){return N(ce,t)}function ie(){return P(ce)}function ue(){return O()}const le="media-cache-",fe="-cache-",de=6048e5;let he=de;function ge(t){const e=(t=t.substring(le.length)).indexOf(fe);return[t.substring(0,e),t.substring(e+fe.length)]}async function ye(){return(await M()).filter((t=>t.startsWith(le))).sort()}async function we(t){const e=await ye();for(const n of e){if(t===ge(n)[1])return P(n)}}async function me(t,e){const n=await ye();if(n.map(ge).map((t=>t[1])).includes(t))return;for(;n.length>=4;)await L(n.shift());for(const o of n){const t=ge(o)[0];Date.now()-Date.parse(t)>=he&&await L(o)}const s=function(t,e){return`media-cache-${t}-cache-${e}`}((new Date).toISOString(),t);await N(s,e)}async function pe(t){const e=await ye();for(const n of e){ge(n)[1]===t&&await L(n)}}async function be(){return(await ye()).map(ge).map((t=>t[1]))}function _e(t){he=t}},8513:(t,e,n)=>{"use strict";n.d(e,{f:()=>s,P:()=>o});const s=432e6,o=3e5},2961:(t,e,n)=>{"use strict";n.d(e,{L:()=>s,q:()=>o});const s=20,o={home:{name:"home",label:"Home"},local:{name:"local",label:"Local"},federated:{name:"federated",label:"Federated"}}},4986:(t,e,n)=>{"use strict";n.d(e,{c:()=>o});var s=n(9749);class o extends s.EventEmitter{constructor(t={}){if(super(),!(t.maxSize&&t.maxSize>0))throw new TypeError("`maxSize` must be a number greater than 0");this.maxSize=t.maxSize,this.cache=new Map,this.oldCache=new Map,this._size=0}_set(t,e){if(this.cache.set(t,e),this._size++,this._size>=this.maxSize){if(this._size=0,this.listenerCount("evict"))for(const t of this.oldCache.keys())this.cache.has(t)||this.emit("evict",this.oldCache.get(t),t);this.oldCache=this.cache,this.cache=new Map}}get(t){if(this.cache.has(t))return this.cache.get(t);if(this.oldCache.has(t)){const e=this.oldCache.get(t);return this.oldCache.delete(t),this._set(t,e),e}}set(t,e){return this.cache.has(t)?this.cache.set(t,e):this._set(t,e),this}has(t){return this.cache.has(t)||this.oldCache.has(t)}delete(t){const e=this.cache.delete(t);return e&&this._size--,this.oldCache.delete(t)||e}clear(){this.cache.clear(),this.oldCache.clear(),this._size=0}getAllKeys(){const t=new Set;for(const e of this.cache.keys())t.add(e);for(const e of this.oldCache.keys())t.add(e);return t}}},137:(t,e,n)=>{"use strict";n.d(e,{Bu:()=>o,hC:()=>a,gV:()=>r});var s=n(6826);function o(t,e){return(0,s.Sk)(t,e,"0")}function c(t){return o(t,30)}function a(t){const e=c(t);let n="";for(let s=0;s<e.length;s++){const t=170-e.charCodeAt(s);n+=String.fromCharCode(t)}return n}function r(t,e){const n=c(t.id),s=c(e.id);return n<s?-1:n===s?0:1}}}]);
//# sourceMappingURL=166.8812d8059a483fc4ddd1.166.js.map