(this.webpackChunkpinafore=this.webpackChunkpinafore||[]).push([[3754],{3518:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>M});var a=n(4178),r=n(2905),s=n(1382),o=n(3256),i=n(2936),c=n(8273),l=n(1029);const d="read write follow push";var g=n(1281),u=n(8313),h=n(3734),m=n(9054),I=n(1312),p=n(2909);const f=["gab.com","gab.ai"];function v(e){const t=new Error(e);return t.knownError=!0,t}function y(){return`${location.origin}/settings/instances/add`}async function _(){let{instanceNameInSearch:e,loggedInInstances:t}=i.h.get();if(e=e.replace(/^https?:\/\//,"").replace(/\/+$/,"").toLowerCase(),Object.keys(t).includes(e))throw v(`You've already logged in to ${e}`);const n=new URL(`http://${e}`).hostname;if(f.some((e=>new RegExp(`(?:\\.|^)${e}$`,"i").test(n))))throw v("This service is blocked");const a=y(),r=function(e,t){const n=`${(0,l.E)(e)}/api/v1/apps`;return(0,c.v_)(n,{client_name:"Pinafore",redirect_uris:t,scopes:d,website:"https://pinafore.social"},null,{timeout:c.$Q})}(e,a),s=await(0,g.s)(e);await p.F.setInstanceInfo(e,s);const o=await r;i.h.set({currentRegisteredInstanceName:e,currentRegisteredInstance:o}),i.h.save();const u=function(e,t,n){const a=(0,c.pe)({client_id:t,redirect_uri:n,response_type:"code",scope:d});return`${(0,l.E)(e)}/oauth/authorize?${a}`}(e,o.client_id,a);setTimeout((()=>{document.location.href=u}),200)}async function b(e){const{currentRegisteredInstanceName:t,currentRegisteredInstance:n}=i.h.get(),a=y(),r=await function(e,t,n,a,r){const s=`${(0,l.E)(e)}/oauth/token`;return(0,c.v_)(s,{client_id:t,client_secret:n,redirect_uri:r,grant_type:"authorization_code",code:a},null,{timeout:c.$Q})}(t,n.client_id,n.client_secret,e,a),{loggedInInstances:s,loggedInInstancesInOrder:o,instanceThemes:d}=i.h.get();d[t]=h.t0,s[t]=r,o.includes(t)||o.push(t),i.h.set({instanceNameInSearch:"",currentRegisteredInstanceName:null,currentRegisteredInstance:null,loggedInInstances:s,currentInstance:t,loggedInInstancesInOrder:o,instanceThemes:d}),i.h.save();const{enableGrayscale:g}=i.h.get();(0,h.Xi)(h.t0,g),(0,m.Ac)(t),(0,I.Mj)(t),(0,u.E9)("/")}var w=n(7558),$=n(6612);var E={onSubmitInstance(e){e.preventDefault(),e.stopPropagation(),async function(){i.h.set({logInToInstanceLoading:!0,logInToInstanceError:null});try{await _()}catch(e){console.error(e);const t=`${e.message||e.name}. `+(e.knownError?"":navigator.onLine?'\n  Is this a valid Mastodon instance? Is a browser extension\n  blocking the request? Are you in private browsing mode?\n  If you believe this is a problem with your instance, please send\n  <a href="https://github.com/nolanlawson/pinafore/blob/master/docs/Admin-Guide.md"\n    target="_blank" rel="noopener">this link</a> to the administrator of your instance.':"Are you offline?"),{instanceNameInSearch:n}=i.h.get();i.h.set({logInToInstanceError:t,logInToInstanceErrorForText:n})}finally{i.h.set({logInToInstanceLoading:!1})}}()}};async function L(){const e=location.search.match(/code=([^&]+)/);if(e)return async function(e){try{i.h.set({logInToInstanceLoading:!0}),await b(e)}catch(t){i.h.set({logInToInstanceError:`${t.message||t.name}. Failed to connect to instance.`})}finally{i.h.set({logInToInstanceLoading:!1})}}(e[1]);this.set({hasIndexedDB:await(0,w.m)(),hasLocalStorage:(0,w.I)()})}function T(e,t){var n,r;return{c(){n=(0,a.az)("div"),r=(0,a.rw)("It seems Pinafore cannot store data locally. Is your browser in private mode or blocking cookies? Pinafore stores all data locally, and requires LocalStorage and IndexedDB to work correctly."),this.h()},l(e){n=(0,a.d$)(e,"DIV",{class:!0,role:!0},!1);var t=(0,a.pI)(n);r=(0,a.M4)(t,"It seems Pinafore cannot store data locally. Is your browser in private mode or blocking cookies? Pinafore stores all data locally, and requires LocalStorage and IndexedDB to work correctly."),t.forEach(a.r2),this.h()},h(){n.className="form-error form-error-user-error svelte-gnr0mr",(0,a.P$)(n,"role","alert")},m(e,t){(0,a.$T)(e,n,t),(0,a.R3)(n,r)},d(e){e&&(0,a.r2)(n)}}}function x(e,t){var n,r,s;return{c(){n=(0,a.az)("div"),r=(0,a.rw)("Error: "),s=(0,a.az)("noscript"),this.h()},l(e){n=(0,a.d$)(e,"DIV",{class:!0,role:!0},!1);var t=(0,a.pI)(n);r=(0,a.M4)(t,"Error: "),s=(0,a.az)("noscript"),t.forEach(a.r2),this.h()},h(){n.className="form-error form-error-user-error svelte-gnr0mr",(0,a.P$)(n,"role","alert")},m(e,o){(0,a.$T)(e,n,o),(0,a.R3)(n,r),(0,a.R3)(n,s),s.insertAdjacentHTML("afterend",t.$logInToInstanceError)},p(e,t){e.$logInToInstanceError&&((0,a.R6)(s),s.insertAdjacentHTML("afterend",t.$logInToInstanceError))},d(e){e&&(0,a.r2)(n)}}}function R(e,t){var n,r,s,o,i,c=new $.Z({root:e.root,store:e.store,data:{text:"instance",tooltipText:"An instance is your Mastodon home server, such as mastodon.social or cybre.space."}});return{c(){n=(0,a.az)("p"),r=(0,a.rw)("Don't have an\n      "),c._fragment.c(),s=(0,a.rw)("\n      ?\n      "),o=(0,a.az)("a"),i=(0,a.rw)("Join Mastodon!"),this.h()},l(e){n=(0,a.d$)(e,"P",{},!1);var t=(0,a.pI)(n);r=(0,a.M4)(t,"Don't have an\n      "),c._fragment.l(t),s=(0,a.M4)(t,"\n      ?\n      "),o=(0,a.d$)(t,"A",{rel:!0,target:!0,href:!0},!1);var l=(0,a.pI)(o);i=(0,a.M4)(l,"Join Mastodon!"),l.forEach(a.r2),t.forEach(a.r2),this.h()},h(){o.rel="noopener",o.target="_blank",o.href="https://joinmastodon.org"},m(e,t){(0,a.$T)(e,n,t),(0,a.R3)(n,r),c._mount(n,null),(0,a.R3)(n,s),(0,a.R3)(n,o),(0,a.R3)(o,i)},d(e){e&&(0,a.r2)(n),c.destroy()}}}function N(e){var t;if((0,a.S1)(this,e),this.store=i.h,this._state=(0,a.f0)((0,a.f0)(this.store._init(["isUserLoggedIn","logInToInstanceError","logInToInstanceErrorForText","instanceNameInSearch","logInToInstanceLoading"]),{hasIndexedDB:!0,hasLocalStorage:!0}),e.data),this.store._add(this,["isUserLoggedIn","logInToInstanceError","logInToInstanceErrorForText","instanceNameInSearch","logInToInstanceLoading"]),this._recompute({$isUserLoggedIn:1},this._state),this._intro=!0,this._handlers.destroy=[a.iT],document.getElementById("svelte-gnr0mr-style")||((t=(0,a.az)("style")).id="svelte-gnr0mr-style",t.textContent=".add-new-instance.svelte-gnr0mr{background:var(--form-bg);padding:5px 10px 15px;margin:20px auto;border:1px solid var(--form-border);border-radius:4px}.form-error.svelte-gnr0mr{border:2px solid var(--warn-color);border-radius:2px;padding:10px;font-size:1.3em;margin:5px;background-color:var(--main-bg)}input.svelte-gnr0mr{min-width:70%;max-width:100%;background-color:var(--input-bg)}label.svelte-gnr0mr,input.svelte-gnr0mr,button.svelte-gnr0mr,.add-new-instance-aside{display:block;margin:20px 5px}@media(max-width: 767px){input.svelte-gnr0mr{min-width:95%}}",(0,a.R3)(document.head,t)),this._fragment=function(e,t){var n,r,s,i,c,l,d,g,u,h,m,I,p,f,v,y,_,b,w=!1,$=(!t.hasIndexedDB||!t.hasLocalStorage)&&T(),E=t.$logInToInstanceError&&t.$logInToInstanceErrorForText===t.$instanceNameInSearch&&x(0,t);function L(){w=!0,e.store.set({instanceNameInSearch:I.value}),w=!1}function N(t){e.onSubmitInstance(t)}var S=!t.$isUserLoggedIn&&R(e),k={page:"settings/instances/add",label:t.pageLabel},M=new o.Z({root:e.root,store:e.store,slots:{default:(0,a.xJ)()},data:k});return{c(){n=(0,a.az)("h1"),r=(0,a.rw)(t.pageLabel),s=(0,a.rw)("\n\n  "),i=(0,a.az)("div"),c=(0,a.az)("form"),$&&$.c(),l=(0,a.rw)("\n\n      "),E&&E.c(),d=(0,a.rw)("\n\n      "),g=(0,a.rw)("\n\n      "),u=(0,a.az)("label"),h=(0,a.rw)("Instance:"),m=(0,a.rw)("\n      "),I=(0,a.az)("input"),p=(0,a.rw)("\n      "),f=(0,a.az)("button"),v=(0,a.rw)("Log in"),_=(0,a.rw)("\n\n  "),S&&S.c(),b=(0,a.Yr)(),M._fragment.c(),this.h()},l(e){n=(0,a.d$)(e,"H1",{id:!0},!1);var o=(0,a.pI)(n);r=(0,a.M4)(o,t.pageLabel),o.forEach(a.r2),s=(0,a.M4)(e,"\n\n  "),i=(0,a.d$)(e,"DIV",{class:!0},!1);var y=(0,a.pI)(i);c=(0,a.d$)(y,"FORM",{"aria-labelledby":!0},!1);var w=(0,a.pI)(c);$&&$.l(w),l=(0,a.M4)(w,"\n\n      "),E&&E.l(w),d=(0,a.M4)(w,"\n\n      "),g=(0,a.M4)(w,"\n\n      "),u=(0,a.d$)(w,"LABEL",{for:!0,class:!0},!1);var L=(0,a.pI)(u);h=(0,a.M4)(L,"Instance:"),L.forEach(a.r2),m=(0,a.M4)(w,"\n      "),I=(0,a.d$)(w,"INPUT",{type:!0,inputmode:!0,autocapitalize:!0,spellcheck:!0,id:!0,placeholder:!0,required:!0,class:!0},!1),(0,a.pI)(I).forEach(a.r2),p=(0,a.M4)(w,"\n      "),f=(0,a.d$)(w,"BUTTON",{class:!0,type:!0,id:!0,disabled:!0},!1);var T=(0,a.pI)(f);v=(0,a.M4)(T,"Log in"),T.forEach(a.r2),w.forEach(a.r2),y.forEach(a.r2),_=(0,a.M4)(e,"\n\n  "),S&&S.l(e),b=(0,a.Yr)(),M._fragment.l(e),this.h()},h(){n.id="add-an-instance-h1",u.htmlFor="instanceInput",u.className="svelte-gnr0mr",(0,a.NH)(I,"input",L),(0,a.P$)(I,"type","text"),(0,a.P$)(I,"inputmode","url"),(0,a.P$)(I,"autocapitalize","none"),I.spellcheck="false",I.id="instanceInput",I.placeholder="Enter instance name",I.required=!0,I.className="svelte-gnr0mr",f.className="primary svelte-gnr0mr",f.type="submit",f.id="submitButton",f.disabled=y=!t.$instanceNameInSearch||t.$logInToInstanceLoading,(0,a.NH)(c,"submit",N),(0,a.P$)(c,"aria-labelledby","add-an-instance-h1"),i.className="add-new-instance svelte-gnr0mr"},m(e,o){(0,a.R3)(M._slotted.default,n),(0,a.R3)(n,r),(0,a.R3)(M._slotted.default,s),(0,a.R3)(M._slotted.default,i),(0,a.R3)(i,c),$&&$.m(c,null),(0,a.R3)(c,l),E&&E.m(c,null),(0,a.R3)(c,d),(0,a.R3)(c,g),(0,a.R3)(c,u),(0,a.R3)(u,h),(0,a.R3)(c,m),(0,a.R3)(c,I),I.value=t.$instanceNameInSearch,(0,a.R3)(c,p),(0,a.R3)(c,f),(0,a.R3)(f,v),(0,a.R3)(M._slotted.default,_),S&&S.m(M._slotted.default,null),(0,a.R3)(M._slotted.default,b),M._mount(e,o)},p(t,n){t.pageLabel&&(0,a.a_)(r,n.pageLabel),n.hasIndexedDB&&n.hasLocalStorage?$&&($.d(1),$=null):$||(($=T()).c(),$.m(c,l)),n.$logInToInstanceError&&n.$logInToInstanceErrorForText===n.$instanceNameInSearch?E?E.p(t,n):((E=x(0,n)).c(),E.m(c,d)):E&&(E.d(1),E=null),!w&&t.$instanceNameInSearch&&(I.value=n.$instanceNameInSearch),(t.$instanceNameInSearch||t.$logInToInstanceLoading)&&y!==(y=!n.$instanceNameInSearch||n.$logInToInstanceLoading)&&(f.disabled=y),n.$isUserLoggedIn?S&&(S.d(1),S=null):S||((S=R(e)).c(),S.m(b.parentNode,b));var s={};t.pageLabel&&(s.label=n.pageLabel),M._set(s)},d(e){$&&$.d(),E&&E.d(),(0,a.ys)(I,"input",L),(0,a.ys)(c,"submit",N),S&&S.d(),M.destroy(e)}}}(this,this._state),this.root._oncreate.push((()=>{L.call(this),this.fire("update",{changed:(0,a.lZ)({},this._state),current:this._state})})),e.target){var n=(0,a.pI)(e.target);e.hydrate?this._fragment.l(n):this._fragment.c(),n.forEach(a.r2),this._mount(e.target,e.anchor),(0,a.yl)(this)}}(0,a.f0)(N.prototype,a.uS),(0,a.f0)(N.prototype,E),N.prototype._recompute=function(e,t){e.$isUserLoggedIn&&this._differs(t.pageLabel,t.pageLabel=function({$isUserLoggedIn:e}){return e?"Add instance":"Log in"}(t))&&(e.pageLabel=!0)};const S=N;function k(e){var t,n,o,i,c,l,d;if((0,a.S1)(this,e),this._state=(0,a.f0)((0,a.f0)(this.store._init(["isUserLoggedIn"]),{pageComponent:S}),e.data),this.store._add(this,["isUserLoggedIn"]),this._recompute({$isUserLoggedIn:1},this._state),this._intro=!0,this._handlers.destroy=[a.iT],this._fragment=(t=this,n=this._state,i={name:n.titleName,settingsPage:!0},c=new r.Z({root:t.root,store:t.store,data:i}),l={pageComponent:n.pageComponent,params:n.params},d=new s.Z({root:t.root,store:t.store,data:l}),{c(){c._fragment.c(),o=(0,a.rw)("\n\n  "),d._fragment.c()},l(e){c._fragment.l(e),o=(0,a.M4)(e,"\n\n  "),d._fragment.l(e)},m(e,t){c._mount(e,t),(0,a.$T)(e,o,t),d._mount(e,t)},p(e,t){var n={};e.titleName&&(n.name=t.titleName),c._set(n);var a={};e.pageComponent&&(a.pageComponent=t.pageComponent),e.params&&(a.params=t.params),d._set(a)},d(e){c.destroy(e),e&&(0,a.r2)(o),d.destroy(e)}}),e.target){var g=(0,a.pI)(e.target);e.hydrate?this._fragment.l(g):this._fragment.c(),g.forEach(a.r2),this._mount(e.target,e.anchor),(0,a.yl)(this)}}(0,a.f0)(k.prototype,a.uS),k.prototype._recompute=function(e,t){e.$isUserLoggedIn&&this._differs(t.titleName,t.titleName=function({$isUserLoggedIn:e}){return e?"Add instance":"Log in"}(t))&&(e.titleName=!0)};const M=k},1312:(e,t,n)=>{"use strict";n.d(t,{Q0:()=>u,ic:()=>g,Mj:()=>d});var a=n(3242),r=n(2909),s=n(1029),o=n(8273);var i=n(2936),c=n(9921);async function l(e,t){await t((()=>{const{loggedInInstances:t}=i.h.get(),n=t[e].access_token;return function(e,t){const n=`${(0,s.E)(e)}/api/v1/custom_emojis`;return(0,o.U2)(n,(0,s.I)(t),{timeout:o.EH})}(e,n)}),(()=>r.F.getCustomEmoji(e)),(t=>r.F.setCustomEmoji(e,t)),(t=>{const{customEmoji:n}=i.h.get();(0,c.Z)(n[e],t)||(n[e]=t,i.h.set({customEmoji:n}))}))}async function d(e){await l(e,a.u)}async function g(e){await l(e,a.o)}function u(e,t){const n=t.unicode||`:${t.name}:`,{composeSelectionStart:a}=i.h.get(),r=a||0,s=i.h.getComposeData(e,"text")||"",o=`${s.substring(0,r)}${n} ${s.substring(r)}`;i.h.setComposeData(e,{text:o})}},9054:(e,t,n)=>{"use strict";n.d(t,{Lr:()=>u,jh:()=>m,rd:()=>h,Q:()=>p,Ac:()=>I});var a=n(4511),r=n(2936),s=n(3734),o=n(6494),i=n(8313),c=n(3242),l=n(1281),d=n(2909);var g=n(7265);function u(e,t){const{instanceThemes:n}=r.h.get();n[e]=t,r.h.set({instanceThemes:n}),r.h.save();const{currentInstance:a}=r.h.get();if(e===a){const{enableGrayscale:e}=r.h.get();(0,s.Xi)(t,e)}}function h(e){const{instanceThemes:t}=r.h.get();r.h.set({currentInstance:e,searchResults:null,queryInSearch:""}),r.h.save();const{enableGrayscale:n}=r.h.get();(0,s.Xi)(t[e],n)}async function m(e,t){t=t||(0,g.A)(["Logged out of ",["instance"]],{instance:e});const{composeData:a,currentInstance:c,customEmoji:l,instanceInfos:u,instanceLists:h,instanceThemes:m,loggedInInstances:I,loggedInInstancesInOrder:p,verifyCredentials:f}=r.h.get();p.splice(p.indexOf(e),1);const v=e===c?p[0]:c,y=[a,l,u,h,m,I,f];for(const n of y)delete n[e];r.h.set({composeData:a,currentInstance:v,customEmoji:l,instanceInfos:u,instanceLists:h,instanceThemes:m,loggedInInstances:I,loggedInInstancesInOrder:p,queryInSearch:"",searchResults:null,timelineInitialized:!1,timelinePreinitialized:!1,verifyCredentials:f}),r.h.clearTimelineDataForInstance(e),r.h.clearAutosuggestDataForInstance(e),r.h.save();const{virtualListStore:_}=await Promise.all([n.e(9921),n.e(1257),n.e(1089)]).then(n.bind(n,1257));_.clearRealmByPrefix(c+"/"),o.A.say(t);const{enableGrayscale:b}=r.h.get();(0,s.Xi)(m[v],b),d.F.clearDatabaseForInstance(e),(0,i.E9)("/settings/instances")}async function I(e){const{loggedInInstances:t}=r.h.get(),n=t[e].access_token;await(0,c.u)((()=>(0,a.Q)(e,n).catch(function(e){return async t=>{throw t.message.startsWith("401:")&&await m(e,(0,g.A)(["The access token was revoked, logged out of ",["instance"]],{instance:e})),t}}(e))),(()=>d.F.getInstanceVerifyCredentials(e)),(t=>d.F.setInstanceVerifyCredentials(e,t)),(t=>function(e,t){const{verifyCredentials:n}=r.h.get();n[e]=t,r.h.set({verifyCredentials:n})}(e,t)))}async function p(e){await(0,c.u)((()=>(0,l.s)(e)),(()=>d.F.getInstanceInfo(e)),(t=>d.F.setInstanceInfo(e,t)),(t=>{const{instanceInfos:n}=r.h.get();n[e]=t,r.h.set({instanceInfos:n})}))}},1281:(e,t,n)=>{"use strict";n.d(t,{s:()=>s});var a=n(8273),r=n(1029);function s(e){const t=`${(0,r.E)(e)}/api/v1/instance`;return(0,a.U2)(t,null,{timeout:a.EH})}},4511:(e,t,n)=>{"use strict";n.d(t,{Q:()=>s,D:()=>o});var a=n(8273),r=n(1029);function s(e,t){const n=`${(0,r.E)(e)}/api/v1/accounts/verify_credentials`;return(0,a.U2)(n,(0,r.I)(t),{timeout:a.EH})}function o(e,t,n){const s=`${(0,r.E)(e)}/api/v1/accounts/${n}`;return(0,a.U2)(s,(0,r.I)(t),{timeout:a.EH})}},2909:(e,t,n)=>{"use strict";n.d(t,{F:()=>a});const a=new Proxy({},{get:function(e,t){return async function(...a){if(!e[t]){const a=await Promise.all([n.e(3881),n.e(166)]).then(n.bind(n,166));e[t]=a[t]}return e[t].apply(null,a)}}})},3242:(e,t,n)=>{"use strict";async function a(e,t,n,a){const r=e();let s;try{s=await t()}catch(o){console.error("ignored DB error",o)}finally{s&&a(s);const e=r.then((e=>{n(e),a(e)}));s||await e}}async function r(e,t,n,a){let r;try{r=await t()}catch(s){console.error("ignored DB error",s)}if(r)a(r);else{const t=await e();n(t),a(t)}}n.d(t,{u:()=>a,o:()=>r})}}]);
//# sourceMappingURL=3754.c0ddeb6989229311949e.settings_instances_add.js.map