{"version":3,"file":"inline-script.js","sources":["src/routes/_utils/themeEngine.js","src/routes/_utils/thunk.js","src/routes/_utils/testStorage.js","src/routes/_store/storeLite.js","src/routes/_utils/safeParse.js","src/routes/_utils/userAgent/isIOS.js","src/routes/_utils/userAgent/isIOSPre12Point2.js","src/routes/_utils/userAgent/isMac.js","src/inline-script/inline-script.js","src/routes/_api/utils.js","src/routes/_actions/onUserIsLoggedOut.js"],"sourcesContent":["const prefersDarkTheme = process.browser && matchMedia('(prefers-color-scheme: dark)').matches\nconst meta = process.browser && document.getElementById('theThemeColor')\n\nexport const INLINE_THEME = 'default' // theme that does not require external CSS\nexport const DEFAULT_LIGHT_THEME = 'default' // theme that is shown by default\nexport const DEFAULT_DARK_THEME = 'ozark' // theme that is shown for prefers-color-scheme:dark\nexport const DEFAULT_THEME = prefersDarkTheme ? DEFAULT_DARK_THEME : DEFAULT_LIGHT_THEME\n\nfunction getExistingThemeLink () {\n  return document.head.querySelector('link[rel=stylesheet][href^=\"/theme-\"]')\n}\n\nfunction resetExistingTheme () {\n  const existingLink = getExistingThemeLink()\n  if (existingLink) {\n    document.head.removeChild(existingLink)\n  }\n}\n\nfunction loadCSS (href) {\n  const existingLink = getExistingThemeLink()\n\n  const link = document.createElement('link')\n  link.rel = 'stylesheet'\n  link.href = href\n\n  link.addEventListener('load', function onload () {\n    link.removeEventListener('load', onload)\n    if (existingLink) { // remove after load to avoid flash of default theme\n      document.head.removeChild(existingLink)\n    }\n  })\n\n  document.head.appendChild(link)\n}\n\nexport function switchToTheme (themeName = DEFAULT_THEME, enableGrayscale) {\n  if (enableGrayscale) {\n    themeName = prefersDarkTheme ? 'dark-grayscale' : 'grayscale'\n  }\n  const themeColor = window.__themeColors[themeName]\n  meta.content = themeColor || window.__themeColors[DEFAULT_THEME]\n  if (themeName !== INLINE_THEME) {\n    loadCSS(`/theme-${themeName}.css`)\n  } else {\n    resetExistingTheme()\n  }\n}\n","// Run a function once, then cache the result and return the cached result thereafter\nexport function thunk (func) {\n  let cached\n  let runOnce\n  return () => {\n    if (!runOnce) {\n      cached = func()\n      runOnce = true\n    }\n    return cached\n  }\n}\n","// LocalStorage and IDB may be disabled in private mode, when \"blocking cookies\" in Safari,\n// or other cases\n\nimport { thunk } from './thunk'\n\nconst testKey = '__test__'\n\nexport const testHasLocalStorage = thunk(() => {\n  try {\n    localStorage.setItem(testKey, testKey)\n    if (!localStorage.length || localStorage.getItem(testKey) !== testKey) {\n      return false\n    }\n    localStorage.removeItem(testKey)\n  } catch (e) {\n    return false\n  }\n  return true\n})\n\nexport const testHasIndexedDB = thunk(async () => {\n  if (typeof indexedDB === 'undefined') {\n    return false\n  }\n\n  try {\n    const idbFailed = await new Promise(resolve => {\n      const db = indexedDB.open(testKey)\n      db.onerror = () => resolve(true)\n      db.onsuccess = () => {\n        indexedDB.deleteDatabase(testKey)\n        resolve(false)\n      }\n    })\n    if (idbFailed) {\n      return false\n    }\n  } catch (e) {\n    return false\n  }\n  return true\n})\n","// \"lite\" version of the store used in the inline script.\n\nimport { safeParse } from '../_utils/safeParse'\nimport { testHasLocalStorage } from '../_utils/testStorage'\n\nconst hasLocalStorage = testHasLocalStorage()\n\nexport const storeLite = {\n  get () {\n    return new Proxy({}, {\n      get: function (obj, prop) {\n        if (!(prop in obj)) {\n          obj[prop] = hasLocalStorage && safeParse(localStorage.getItem(`store_${prop}`))\n        }\n        return obj[prop]\n      }\n    })\n  },\n\n  set (obj) {\n    if (hasLocalStorage) {\n      for (const [key, value] of Object.entries(obj)) {\n        localStorage.setItem(`store_${key}`, JSON.stringify(value))\n      }\n    }\n  }\n}\n","export function safeParse (str) {\n  return !str ? undefined : (str === 'undefined' ? undefined : JSON.parse(str))\n}\n","import { thunk } from '../thunk'\n\nexport const isIOS = thunk(() => process.browser && /iP(?:hone|ad|od)/.test(navigator.userAgent))\n","// IntersectionObserver introduced in iOS 12.2 https://caniuse.com/#feat=intersectionobserver\nimport { thunk } from '../thunk'\nimport { isIOS } from '../userAgent/isIOS'\n\nexport const isIOSPre12Point2 = thunk(() => process.browser && isIOS() &&\n  !(typeof IntersectionObserver === 'function' &&\n    IntersectionObserver.toString().includes('[native code]')))\n","import { thunk } from '../thunk'\n\nexport const isMac = thunk(() => process.browser && /mac/i.test(navigator.platform))\n","\n// For perf reasons, this script is run inline to quickly set certain styles.\n// To allow CSP to work correctly, we also calculate a sha256 hash during\n// the build process and write it to checksum.js.\n\nimport { INLINE_THEME, DEFAULT_THEME, switchToTheme } from '../routes/_utils/themeEngine'\nimport { basename } from '../routes/_api/utils'\nimport { onUserIsLoggedOut } from '../routes/_actions/onUserIsLoggedOut'\nimport { storeLite } from '../routes/_store/storeLite'\nimport { isIOSPre12Point2 } from '../routes/_utils/userAgent/isIOSPre12Point2'\nimport { isMac } from '../routes/_utils/userAgent/isMac'\n\nwindow.__themeColors = process.env.THEME_COLORS\n\nconst {\n  currentInstance,\n  instanceThemes,\n  disableCustomScrollbars,\n  enableGrayscale,\n  pushSubscription,\n  loggedInInstancesInOrder\n} = storeLite.get()\n\nconst theme = (instanceThemes && instanceThemes[currentInstance]) || DEFAULT_THEME\n\nif (currentInstance) {\n  // Do preconnect if we're logged in, so we can connect faster to the other origin.\n  const link = document.createElement('link')\n  link.setAttribute('rel', 'preconnect')\n  link.setAttribute('href', basename(currentInstance))\n  link.setAttribute('crossorigin', 'anonymous')\n  document.head.appendChild(link)\n}\n\nif (theme !== INLINE_THEME) {\n  // switch theme ASAP to minimize flash of default theme\n  switchToTheme(theme, enableGrayscale)\n}\n\nif (enableGrayscale) {\n  document.getElementById('theGrayscaleStyle')\n    .setAttribute('media', 'all') // enables the style\n}\n\nif (!currentInstance) {\n  // if not logged in, show all these 'hidden-from-ssr' elements\n  onUserIsLoggedOut()\n}\n\nif (disableCustomScrollbars) {\n  document.getElementById('theScrollbarStyle')\n    .setAttribute('media', 'only x') // disables the style\n}\n\n// hack to make the scrollbars rounded only on macOS\nif (isMac()) {\n  document.documentElement.style.setProperty('--scrollbar-border-radius', '50px')\n}\n\n// Versions of iOS Safari before iOS 12.2 do not work properly as a PWA\n// for cross-origin authentication: https://github.com/nolanlawson/pinafore/issues/45\n// Here we sniff for iOS <12.2 by checking for the existence of a native IntersectionObserver\n// function, which was added in 12.2.\nif (isIOSPre12Point2()) {\n  document.head.removeChild(document.getElementById('theManifest'))\n}\n\nif (pushSubscription) {\n  // Fix a bug in Pinafore <=v1.9.0 if we only have one instance we're logged in to\n  // (https://github.com/nolanlawson/pinafore/issues/1274)\n  if (loggedInInstancesInOrder && loggedInInstancesInOrder.length === 1) {\n    storeLite.set({\n      pushSubscriptions: {\n        [currentInstance]: pushSubscription\n      }\n    })\n  }\n  storeLite.set({\n    pushSubscription: null\n  })\n}\n","function targetIsLocalhost (instanceName) {\n  return instanceName.startsWith('localhost:') || instanceName.startsWith('127.0.0.1:')\n}\n\nexport function basename (instanceName) {\n  if (targetIsLocalhost(instanceName)) {\n    return `http://${instanceName}`\n  }\n  return `https://${instanceName}`\n}\n\nexport function auth (accessToken) {\n  return {\n    Authorization: `Bearer ${accessToken}`\n  }\n}\n","// When the user is logged out, we need to be sure to re-show all the \"hidden from SSR\" styles\n// so that we don't get a blank page.\nexport function onUserIsLoggedOut () {\n  if (document.getElementById('hiddenFromSsrStyle')) {\n    return\n  }\n  const style = document.createElement('style')\n  style.setAttribute('id', 'hiddenFromSsrStyle')\n  style.textContent = '.hidden-from-ssr { opacity: 1 !important; }'\n  document.head.appendChild(style)\n}\n"],"names":["prefersDarkTheme","matchMedia","matches","meta","document","getElementById","INLINE_THEME","DEFAULT_THEME","getExistingThemeLink","head","querySelector","thunk","func","cached","runOnce","testKey","hasLocalStorage","localStorage","setItem","length","getItem","removeItem","e","testHasLocalStorage","storeLite","get","Proxy","obj","prop","str","undefined","JSON","parse","[object Object]","key","value","Object","entries","stringify","isIOS","test","navigator","userAgent","isIOSPre12Point2","IntersectionObserver","toString","includes","isMac","platform","window","__themeColors","currentInstance","instanceThemes","disableCustomScrollbars","enableGrayscale","pushSubscription","loggedInInstancesInOrder","theme","link","createElement","setAttribute","instanceName","startsWith","targetIsLocalhost","appendChild","themeName","themeColor","content","href","existingLink","rel","addEventListener","onload","removeEventListener","removeChild","loadCSS","resetExistingTheme","switchToTheme","style","textContent","onUserIsLoggedOut","documentElement","setProperty","set","pushSubscriptions"],"mappings":"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"}