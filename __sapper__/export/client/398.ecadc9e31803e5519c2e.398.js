(this.webpackChunkpinafore=this.webpackChunkpinafore||[]).push([[398],{398:(t,e,n)=>{"use strict";function o(t){if("string"!=typeof t||!t)throw new Error("expected a non-empty string, got: "+t)}function r(t){if("number"!=typeof t)throw new Error("expected a number, got: "+t)}n.d(e,{Z:()=>G});const s="emoji",i="keyvalue",a="favorites",c="tokens",u="count",f="group-order",d="eTag",h="url",l="skinTone",w="readonly",y="readwrite",m="skinUnicodes";function p(t){return function(t,e){const n=new Set,o=[];for(const r of t){const t=e(r);n.has(t)||(n.add(t),o.push(r))}return o}(t,(t=>t.unicode))}const g={},_={},b={};function k(t,e,n){n.onerror=()=>e(n.error),n.onblocked=()=>e(new Error("IDB blocked")),n.onsuccess=()=>t(n.result)}async function j(t){const e=await new Promise(((e,n)=>{const o=indexedDB.open(t,1);g[t]=o,o.onupgradeneeded=t=>{t.oldVersion<1&&function(t){function e(e,n,o){const r=n?t.createObjectStore(e,{keyPath:n}):t.createObjectStore(e);if(o)for(const[t,[s,i]]of Object.entries(o))r.createIndex(t,s,{multiEntry:i});return r}e(i),e(s,"unicode",{[c]:["tokens",!0],[f]:[["group","order"]],[m]:["skinUnicodes",!0]}),e(a,void 0,{[u]:[""]})}(o.result)},k(e,n,o)}));return e.onclose=()=>S(t),e}function v(t,e,n,o){return new Promise(((r,s)=>{const i=t.transaction(e,n),a="string"==typeof e?i.objectStore(e):e.map((t=>i.objectStore(t)));let c;o(a,(t=>{c=t})),i.oncomplete=()=>r(c),i.onerror=()=>s(i.error)}))}function S(t){const e=g[t],n=e&&e.result;if(n){n.close();const e=b[t];if(e)for(const t of e)t()}delete g[t],delete _[t],delete b[t]}const C=new Set([":D","xD",":'D","o:)",":x",":p",";p","xp",":l",":z",":j","8D","xo","8)",":B",":o",":s",":'o","Dx","x(","D:",":c",">0)",":3","</3","<3","\\m/",":E","8#"]);function E(t){return t.split(/[\s_]+/).map((t=>!t.match(/\w/)||C.has(t)?t.toLowerCase():t.replace(/[)(:,]/g,"").replace(/’/g,"'").toLowerCase())).filter(Boolean)}function x(t){return t.filter(Boolean).map((t=>t.toLowerCase())).filter((t=>t.length>=2))}function A(t,e,n,o){t[e](n).onsuccess=t=>o&&o(t.target.result)}function B(t,e,n){A(t,"get",e,n)}function D(t,e,n){A(t,"getAll",e,n)}function L(t,e){const n=function(t,e){let n=t[0];for(let o=1;o<t.length;o++){const r=t[o];e(n)>e(r)&&(n=r)}return n}(t,(t=>t.length)),o=[];for(const r of n)t.some((t=>-1===t.findIndex((t=>e(t)===e(r)))))||o.push(r);return o}async function U(t,e,n,o){try{const r=function(t){return t.map((({annotation:t,emoticon:e,group:n,order:o,shortcodes:r,skins:s,tags:i,emoji:a,version:c})=>{const u=[...new Set(x([...(r||[]).map(E).flat(),...i.map(E).flat(),...E(t),e]))].sort(),f={annotation:t,group:n,order:o,tags:i,tokens:u,unicode:a,version:c};if(e&&(f.emoticon=e),r&&(f.shortcodes=r),s){f.skinTones=[],f.skinUnicodes=[],f.skinVersions=[];for(const{tone:t,emoji:e,version:n}of s)f.skinTones.push(t),f.skinUnicodes.push(e),f.skinVersions.push(n)}return f}))}(e);await v(t,[s,i],y,(([t,e])=>{let s,i,a,c=0;function u(){3==++c&&function(){if(s===o&&i===n)return;for(const e of a)t.delete(e);for(const e of r)t.put(e);e.put(o,d),e.put(n,h)}()}B(e,d,(t=>{s=t,u()})),B(e,h,(t=>{i=t,u()})),A(t,"getAllKeys",void 0,(t=>{a=t,u()}))}))}finally{}}async function T(t,e){const n=x(E(e));return n.length?v(t,s,w,((t,e)=>{const o=[],r=()=>{const t=L(o,(t=>t.unicode));e(t.sort(((t,e)=>t.order<e.order?-1:1)))};for(let s=0;s<n.length;s++){const e=n[s],i=s===n.length-1?IDBKeyRange.bound(e,e+"￿",!1,!0):IDBKeyRange.only(e);D(t.index(c),i,(t=>{o.push(t),o.length===n.length&&r()}))}})):[]}async function N(t,e){const n=await T(t,e);if(!n.length){const n=t=>(t.shortcodes||[]).includes(e.toLowerCase());return await async function(t,e){return v(t,s,w,((t,n)=>{let o;const r=()=>{t.getAll(o&&IDBKeyRange.lowerBound(o,!0),50).onsuccess=t=>{const s=t.target.result;for(const r of s)if(o=r.unicode,e(r))return n(r);if(s.length<50)return n();r()}};r()}))}(t,n)||null}return n.filter((t=>(t.shortcodes||[]).map((t=>t.toLowerCase())).includes(e.toLowerCase())))[0]||null}function I(t,e,n){return v(t,e,w,((t,e)=>B(t,n,e)))}const P=["name","url"];function K(t){!function(t){const e=t&&Array.isArray(t),n=e&&t.length&&(!t[0]||P.some((e=>!(e in t[0]))));if(!e||n)throw new Error("Custom emojis are in the wrong format")}(t);const e=(t,e)=>t.name.toLowerCase()<e.name.toLowerCase()?-1:1,n=t.sort(e),o=function(t,e){const n=new Map;for(const o of t){const t=e(o);for(const e of t){let t=n;for(let n=0;n<e.length;n++){const o=e.charAt(n);let r=t.get(o);r||(r=new Map,t.set(o,r)),t=r}let r=t.get("");r||(r=[],t.set("",r)),r.push(o)}}return(t,e)=>{let o=n;for(let n=0;n<t.length;n++){const e=t.charAt(n),r=o.get(e);if(!r)return[];o=r}if(e)return o.get("")||[];const r=[],s=[o];for(;s.length;){const t=[...s.shift().entries()].sort(((t,e)=>t[0]<e[0]?-1:1));for(const[e,n]of t)""===e?r.push(...n):s.push(n)}return r}}(t,(t=>[...new Set((t.shortcodes||[]).map((t=>E(t))).flat())])),r=t=>o(t,!0),s=t=>o(t,!1),i=new Map,a=new Map;for(const c of t){a.set(c.name.toLowerCase(),c);for(const t of c.shortcodes||[])i.set(t.toLowerCase(),c)}return{all:n,search:t=>{const n=E(t);return L(n.map(((t,e)=>(e<n.length-1?r:s)(t))),(t=>t.name)).sort(e)},byShortcode:t=>i.get(t.toLowerCase()),byName:t=>a.get(t.toLowerCase())}}function z(t){if(!t)return t;if(delete t.tokens,t.skinTones){const e=t.skinTones.length;t.skins=Array(e);for(let n=0;n<e;n++)t.skins[n]={tone:t.skinTones[n],unicode:t.skinUnicodes[n],version:t.skinVersions[n]};delete t.skinTones,delete t.skinUnicodes,delete t.skinVersions}return t}function M(t){t||function(){console.warn(...arguments)}("emoji-picker-element is more efficient if the dataSource server exposes an ETag header.")}const O=["annotation","emoji","group","order","tags","version"];function V(t,e){if(2!==Math.floor(t.status/100))throw new Error("Failed to fetch: "+e+":  "+t.status)}async function R(t){const e=await fetch(t);V(e,t);const n=e.headers.get("etag");M(n);const o=await e.json();return function(t){if(!t||!Array.isArray(t)||!t[0]||"object"!=typeof t[0]||O.some((e=>!(e in t[0]))))throw new Error("Emoji data is in the wrong format")}(o),[n,o]}async function F(t){const e=function(t){for(var e=t.length,n=new ArrayBuffer(e),o=new Uint8Array(n),r=-1;++r<e;)o[r]=t.charCodeAt(r);return n}(JSON.stringify(t)),n=function(t){for(var e="",n=new Uint8Array(t),o=n.byteLength,r=-1;++r<o;)e+=String.fromCharCode(n[r]);return e}(await crypto.subtle.digest("SHA-1",e));return btoa(n)}async function H(t,e){let n,o=await async function(t){const e=await fetch(t,{method:"HEAD"});V(e,t);const n=e.headers.get("etag");return M(n),n}(e);if(!o){const t=await R(e);o=t[0],n=t[1],o||(o=await F(n))}if(await async function(t,e,n){const[o,r]=await Promise.all([d,h].map((e=>I(t,i,e))));return o===n&&r===e}(t,e,o));else{if(!n){n=(await R(e))[1]}await U(t,n,e,o)}}const G=class{constructor({dataSource:t="https://cdn.jsdelivr.net/npm/emoji-picker-element-data@^1/en/emojibase/data.json",locale:e="en",customEmoji:n=[]}={}){this.dataSource=t,this.locale=e,this._dbName=`emoji-picker-element-${this.locale}`,this._db=void 0,this._lazyUpdate=void 0,this._custom=K(n),this._clear=this._clear.bind(this),this._ready=this._init()}async _init(){const t=this._db=await(e=this._dbName,_[e]||(_[e]=j(e)),_[e]);var e;!function(t,e){let n=b[t];n||(n=b[t]=[]),n.push(e)}(this._dbName,this._clear);const n=this.dataSource;await async function(t){return!(await I(t,i,h))}(t)?await async function(t,e){let[n,o]=await R(e);n||(n=await F(o)),await U(t,o,e,n)}(t,n):this._lazyUpdate=H(t,n)}async ready(){return this._ready||(this._ready=this._init()),this._ready}async getEmojiByGroup(t){return r(t),await this.ready(),p(await async function(t,e){return v(t,s,w,((t,n)=>{const o=IDBKeyRange.bound([e,0],[e+1,0],!1,!0);D(t.index(f),o,n)}))}(this._db,t)).map(z)}async getEmojiBySearchQuery(t){o(t),await this.ready();return[...this._custom.search(t),...p(await T(this._db,t)).map(z)]}async getEmojiByShortcode(t){o(t),await this.ready();const e=this._custom.byShortcode(t);return e||z(await N(this._db,t))}async getEmojiByUnicodeOrName(t){o(t),await this.ready();const e=this._custom.byName(t);return e||z(await async function(t,e){return v(t,s,w,((t,n)=>B(t,e,(o=>{if(o)return n(o);B(t.index(m),e,(t=>n(t||null)))}))))}(this._db,t))}async getPreferredSkinTone(){return await this.ready(),await I(this._db,i,l)||0}async setPreferredSkinTone(t){return r(t),await this.ready(),e=this._db,n=l,o=t,v(e,i,y,(t=>t.put(o,n)));var e,n,o}async incrementFavoriteEmojiCount(t){return o(t),await this.ready(),e=this._db,n=t,v(e,a,y,(t=>{B(t,n,(e=>t.put((e||0)+1,n)))}));var e,n}async getTopFavoriteEmoji(t){return r(t),await this.ready(),(await function(t,e,n){return 0===n?[]:v(t,[a,s],w,(([t,o],r)=>{const s=[];t.index(u).openCursor(void 0,"prev").onsuccess=t=>{const i=t.target.result;if(!i)return r(s);function a(t){if(s.push(t),s.length===n)return r(s);i.continue()}const c=i.primaryKey,u=e.byName(c);if(u)return a(u);B(o,c,(t=>{if(t)return a(t);i.continue()}))}}))}(this._db,this._custom,t)).map(z)}set customEmoji(t){this._custom=K(t)}get customEmoji(){return this._custom.all}async _shutdown(){await this.ready();try{await this._lazyUpdate}catch(t){}return!!this._db}_clear(){this._dbName,this._db=this._ready=this._lazyUpdate=void 0}async close(){await this._shutdown()&&await S(this._dbName)}async delete(){var t;await this._shutdown()&&await(t=this._dbName,new Promise(((e,n)=>{S(t),k(e,n,indexedDB.deleteDatabase(t))})))}}}}]);
//# sourceMappingURL=398.ecadc9e31803e5519c2e.398.js.map