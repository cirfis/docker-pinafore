{"version":3,"sources":["webpack://pinafore/./src/routes/_utils/fullscreen.js","webpack://pinafore/./src/routes/_components/virtualList/VirtualListContainer.html","webpack://pinafore/./src/routes/_components/virtualList/VirtualListItem.html","webpack://pinafore/./src/routes/_utils/queueMicrotask.js","webpack://pinafore/./src/routes/_components/virtualList/VirtualListLazyItem.html","webpack://pinafore/./src/routes/_utils/createPriorityQueue.js","webpack://pinafore/./src/routes/_components/virtualList/VirtualListFooter.html","webpack://pinafore/./src/routes/_components/virtualList/VirtualListHeader.html","webpack://pinafore/./src/routes/_components/virtualList/VirtualList.html","webpack://pinafore/./src/routes/_utils/userAgent/isMobile.js"],"names":["isFullscreen","document","fullscreenElement","webkitFullscreenElement","mozFullScreenElement","observe","this","scrollListener","throttle","event","fullscreen","get","onScroll","leading","trailing","listener","onFullscreenChange","bind","addEventListener","removeEventListener","scrollTop","scrollHeight","doubleRAF","store","setForRealm","s","set","offsetHeight","realm","setCurrentRealm","setupScroll","setupFullscreen","onResize","scrollContainer","allVisibleItemsHaveHeight","initializedScrollTop","requestAnimationFrame","fire","teardownScroll","teardownFullscreen","virtualListStore","$allVisibleItemsHaveHeight","rect","refs","node","getBoundingClientRect","key","itemHeights","height","requestPostAnimationFrame","batchUpdateForRealm","doRecalculateHeight","shownBeforeRaf","shown","component","props","index","$length","offset","$itemHeights","qM","queueMicrotask","callback","Promise","resolve","then","catch","e","setTimeout","priorityQueue","tasks","flush","length","sortedTasks","sort","a","b","priority","task","push","createPriorityQueue","makeProps","reduceMotion","async","setProps","isMobile","scheduleIdleTask","undefined","footerHeight","$heightWithoutFooter","heightCalculated","headerHeight","doCalculateHeight","fadedIn","init","virtualProps","offsetParent","listOffset","offsetTop","fireScrollToBottom","fireScrollToTop","showFooter","showHeader","newItems","oldItems","isEqual","items","calculateListOffset","distanceFromBottom","$visibleItems","visibleItem","footerComponent","headerComponent","headerProps","$showHeader","$height","$showFooter","$scrollHeight","$scrollTop","$offsetHeight","map","_","navigator","userAgent","match"],"mappings":"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","file":"5466.24898de194a78906cf79.5466.js","sourcesContent":["export const isFullscreen = () => !!(document.fullscreenElement ||\n  document.webkitFullscreenElement ||\n  document.mozFullScreenElement)\n\nexport const attachFullscreenListener = (listener) => {\n  if ('onfullscreenchange' in document) {\n    document.addEventListener('fullscreenchange', listener)\n  } else if ('onwebkitfullscreenchange' in document) {\n    document.addEventListener('webkitfullscreenchange', listener)\n  } else if ('onmozfullscreenchange' in document) {\n    document.addEventListener('mozfullscreenchange', listener)\n  }\n}\n\nexport const detachFullscreenListener = (listener) => {\n  if ('onfullscreenchange' in document) {\n    document.removeEventListener('fullscreenchange', listener)\n  } else if ('onwebkitfullscreenchange' in document) {\n    document.removeEventListener('webkitfullscreenchange', listener)\n  } else if ('onmozfullscreenchange' in document) {\n    document.removeEventListener('mozfullscreenchange', listener)\n  }\n}\n","<slot></slot>\n<script>\n  import { virtualListStore } from './virtualListStore'\n  import throttle from 'lodash-es/throttle'\n  import { isFullscreen, attachFullscreenListener, detachFullscreenListener } from '../../_utils/fullscreen'\n  import { mark, stop } from '../../_utils/marks'\n  import { doubleRAF } from '../../_utils/doubleRAF'\n  import { observe } from 'svelte-extras'\n  import {\n    addScrollListener,\n    removeScrollListener,\n    getScrollContainer,\n    getOffsetHeight\n  } from '../../_utils/scrollContainer'\n  import { registerResizeListener, unregisterResizeListener } from '../../_utils/resize'\n\n  const SCROLL_EVENT_DELAY = 300\n\n  export default {\n    oncreate () {\n      mark('onCreate VirtualListContainer')\n      const {\n        realm\n      } = this.get()\n      this.store.setCurrentRealm(realm)\n      this.setupScroll()\n      this.setupFullscreen()\n      this.onResize = this.onResize.bind(this)\n      const { scrollTop } = this.store.get()\n      const scrollContainer = getScrollContainer()\n      if (scrollTop > 0) {\n        this.observe('allVisibleItemsHaveHeight', allVisibleItemsHaveHeight => {\n          console.log('allVisibleItemsHaveHeight', allVisibleItemsHaveHeight)\n          const { initializedScrollTop } = this.get()\n          if (!initializedScrollTop && allVisibleItemsHaveHeight) {\n            this.set({ initializedScrollTop: true })\n            requestAnimationFrame(() => {\n              mark('set scrollTop')\n              console.log('forcing scroll top to ', scrollTop)\n              scrollContainer.scrollTop = scrollTop\n              stop('set scrollTop')\n              doubleRAF(() => {\n                console.log('initialized VirtualList (1)')\n                this.fire('initialized')\n              })\n            })\n          }\n        })\n      } else {\n        this.fire('noNeedToScroll')\n        this.observe('allVisibleItemsHaveHeight', allVisibleItemsHaveHeight => {\n          if (allVisibleItemsHaveHeight) {\n            console.log('initialized VirtualList (2)')\n            this.fire('initialized')\n          }\n        })\n        this.onResize()\n      }\n      registerResizeListener(this.onResize)\n      stop('onCreate VirtualListContainer')\n    },\n    ondestroy () {\n      this.teardownScroll()\n      this.teardownFullscreen()\n      this.store.setCurrentRealm(null)\n      unregisterResizeListener(this.onResize)\n    },\n    store: () => virtualListStore,\n    methods: {\n      observe,\n      setupScroll () {\n        this.scrollListener = throttle(event => {\n          const { fullscreen } = this.get()\n          if (fullscreen) {\n            return\n          }\n          this.onScroll()\n        }, SCROLL_EVENT_DELAY, {\n          leading: true,\n          trailing: true\n        })\n        addScrollListener(this.scrollListener)\n      },\n      teardownScroll () {\n        removeScrollListener(this.scrollListener)\n      },\n      setupFullscreen () {\n        this.onFullscreenChange = this.onFullscreenChange.bind(this)\n        attachFullscreenListener(this.onFullscreenChange)\n      },\n      teardownFullscreen () {\n        detachFullscreenListener(this.onFullscreenChange)\n      },\n      onScroll () {\n        const { scrollTop, scrollHeight } = getScrollContainer()\n\n        doubleRAF(() => {\n          mark('onScroll -> setForRealm()')\n          this.store.setForRealm({ scrollTop, scrollHeight })\n          stop('onScroll -> setForRealm()')\n        })\n      },\n      onFullscreenChange () {\n        mark('onFullscreenChange')\n        console.log('is fullscreen? ', isFullscreen())\n        this.set({ fullscreen: isFullscreen() })\n        stop('onFullscreenChange')\n      },\n      onResize () {\n        this.store.setForRealm({\n          scrollHeight: getScrollContainer().scrollHeight,\n          offsetHeight: getOffsetHeight()\n        })\n      }\n    },\n    computed: {\n      // TODO: bug in svelte/store – the observer in oncreate() never get removed without this hack\n      allVisibleItemsHaveHeight: ({ $allVisibleItemsHaveHeight }) => $allVisibleItemsHaveHeight\n    }\n  }\n</script>\n","<div class=\"virtual-list-item list-item {shown ? 'shown' : ''}\"\n     aria-hidden={!shown}\n     ref:node\n     style=\"top: {offset}px;\" >\n  <svelte:component this={component}\n              virtualProps={props}\n              virtualIndex={index}\n              virtualLength={$length}\n              virtualKey={key}\n              on:recalculateHeight=\"doRecalculateHeight()\"/>\n</div>\n<style>\n  .virtual-list-item {\n    position: absolute;\n    width: 100%;\n    opacity: 0;\n    pointer-events: none;\n    transition: opacity 0.2s linear;\n    contain: content; /* see https://www.w3.org/TR/2018/CR-css-contain-1-20181108/#valdef-contain-content */\n  }\n  .virtual-list-item.shown {\n    opacity: 1;\n    pointer-events: auto;\n  }\n</style>\n<script>\n  import { virtualListStore } from './virtualListStore'\n  import { registerResizeListener, unregisterResizeListener } from '../../_utils/resize'\n  import { mark, stop } from '../../_utils/marks'\n  import { requestPostAnimationFrame } from '../../_utils/requestPostAnimationFrame'\n  import { observe } from 'svelte-extras'\n  import { doubleRAF } from '../../_utils/doubleRAF'\n\n  export default {\n    oncreate () {\n      const { key } = this.get()\n      const node = this.refs.node\n      requestPostAnimationFrame(() => {\n        if (!node || !key) {\n          return\n        }\n        mark('VirtualListItem gBCR')\n        const rect = node.getBoundingClientRect()\n        stop('VirtualListItem gBCR')\n        // update all item heights in one batch for better perf\n        this.store.batchUpdateForRealm('itemHeights', key, rect.height)\n      })\n      this.doRecalculateHeight = this.doRecalculateHeight.bind(this)\n      registerResizeListener(this.doRecalculateHeight)\n      // this rAF delay is necessary in order to get the fade-in animation\n      // to consistently show\n      this.observe('shownBeforeRaf', shownBeforeRaf => {\n        doubleRAF(() => {\n          this.set({ shown: shownBeforeRaf })\n        })\n      })\n    },\n    ondestroy () {\n      unregisterResizeListener(this.doRecalculateHeight)\n    },\n    store: () => virtualListStore,\n    data: () => ({\n      shown: false\n    }),\n    computed: {\n      shownBeforeRaf: ({ $itemHeights, key }) => $itemHeights[key] > 0\n    },\n    methods: {\n      observe,\n      doRecalculateHeight () {\n        // Recalculate immediately because this is done on-demand, e.g.\n        // when clicking the \"More\" button on a spoiler.\n        const rect = this.refs.node.getBoundingClientRect()\n        const { key } = this.get()\n        const { itemHeights } = this.store.get()\n        itemHeights[key] = rect.height\n        this.store.setForRealm({ itemHeights })\n      }\n    }\n  }\n</script>\n","// via https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/queueMicrotask\nfunction queueMicrotaskPolyfill (callback) {\n  Promise.resolve()\n    .then(callback)\n    .catch(e => setTimeout(() => { throw e }))\n}\n\nconst qM = typeof queueMicrotask === 'function' ? queueMicrotask : queueMicrotaskPolyfill\n\nexport {\n  qM as queueMicrotask\n}\n","{#if props}\n  <VirtualListItem {component}\n                   {offset}\n                   {props}\n                   {key}\n                   {index}\n  />\n{/if}\n<script>\n  import VirtualListItem from './VirtualListItem'\n  import { mark, stop } from '../../_utils/marks'\n  import { scheduleIdleTask } from '../../_utils/scheduleIdleTask'\n  import { createPriorityQueue } from '../../_utils/createPriorityQueue'\n  import { isMobile } from '../../_utils/userAgent/isMobile'\n  import { store } from '../../_store/store'\n\n  // In Svelte's implementation of lists, these VirtualListLazyItems can be\n  // created in any order. By default in fact it seems to do it in reverse\n  // order, which we don't really want, because then items render in a janky\n  // way, with the last ones first and then replaced by the first ones,\n  // resulting in a UI that looks like a deck of cards being shuffled.\n  // This functions waits a microtask and then ensures that the callbacks\n  // are called by index, in ascending order.\n  const priorityQueue = createPriorityQueue()\n\n  export default {\n    oncreate () {\n      const { makeProps, key, index } = this.get()\n      const { reduceMotion } = this.store.get()\n      if (makeProps) {\n        // TODO: I would use async/await here, but Firefox 68 for Android has a bug where\n        // these don't resolve in the proper order unless I use promises\n        priorityQueue(index).then(async () => {\n          const props = await makeProps(key)\n          const setProps = () => {\n            mark('VirtualListLazyItem set props')\n            this.set({ props: props })\n            stop('VirtualListLazyItem set props')\n          }\n          // On desktop, if prefers-reduced-motion is enabled, avoid using scheduleIdleTask\n          // here because it causes the scrollbar to grow in a way that may sicken\n          // people with vestibular disorders.\n          // TODO: someday we can use isInputPending as a better way to break up work\n          // https://www.chromestatus.com/feature/5719830432841728\n          if (!isMobile() && reduceMotion) {\n            setProps()\n          } else {\n            scheduleIdleTask(setProps)\n          }\n        })\n      }\n    },\n    data: () => ({\n      props: undefined\n    }),\n    store: () => store,\n    components: {\n      VirtualListItem\n    }\n  }\n</script>\n","// Promise-based implementation that waits a microtask tick\n// and executes the resolve() functions in priority order\nimport { queueMicrotask } from './queueMicrotask'\n\nexport function createPriorityQueue () {\n  const tasks = []\n\n  function flush () {\n    if (tasks.length) {\n      const sortedTasks = tasks.sort((a, b) => a.priority < b.priority ? -1 : 1)\n      for (const task of sortedTasks) {\n        task.resolve()\n      }\n      tasks.length = 0\n    }\n  }\n\n  return function next (priority) {\n    return new Promise(resolve => {\n      tasks.push({ priority, resolve })\n      queueMicrotask(flush)\n    })\n  }\n}\n","<div class=\"virtual-list-footer\"\n  ref:node\n  style=\"transform: translateY({$heightWithoutFooter}px);\" >\n  <svelte:component this={component} />\n</div>\n<style>\n  .virtual-list-footer {\n    position: absolute;\n    top: 0;\n    width: 100%;\n  }\n</style>\n<script>\n  import { virtualListStore } from './virtualListStore'\n  import { mark, stop } from '../../_utils/marks'\n\n  export default {\n    oncreate () {\n      requestAnimationFrame(() => {\n        const node = this.refs.node\n        if (!node) {\n          return\n        }\n\n        mark('VirtualListFooter gBCR')\n        const rect = node.getBoundingClientRect()\n        stop('VirtualListFooter gBCR')\n        this.store.setForRealm({ footerHeight: rect.height })\n      })\n    },\n    store: () => virtualListStore\n  }\n</script>","<div class=\"virtual-list-header {shown ? 'shown' : ''} {fadedIn ? 'faded-in' : ''}\"\n     ref:node >\n  <svelte:component this={component} {virtualProps} />\n</div>\n<style>\n  .virtual-list-header {\n    position: absolute;\n    top: 0;\n    width: 100%;\n    opacity: 0;\n    z-index: 10;\n    transition: none;\n    display: none;\n  }\n  .virtual-list-header.shown {\n    display: block;\n    transition: opacity 0.2s linear;\n  }\n  .virtual-list-header.faded-in {\n    opacity: 1;\n  }\n</style>\n<script>\n  import { virtualListStore } from './virtualListStore'\n  import { doubleRAF } from '../../_utils/doubleRAF'\n  import { mark, stop } from '../../_utils/marks'\n  import { observe } from 'svelte-extras'\n\n  export default {\n    oncreate () {\n      this.observe('shown', shown => {\n        if (shown) {\n          this.doCalculateHeight()\n          doubleRAF(() => this.set({ fadedIn: true })) //  animate in\n        } else {\n          this.set({ fadedIn: false })\n        }\n      }, { init: false })\n    },\n    data: () => ({\n      fadedIn: false\n    }),\n    store: () => virtualListStore,\n    methods: {\n      observe,\n      doCalculateHeight () {\n        const { heightCalculated } = this.get()\n        if (heightCalculated) { // only need to calculate once, it never changes\n          return\n        }\n        this.set({ heightCalculated: true })\n        requestAnimationFrame(() => {\n          mark('VirtualListHeader gBCR')\n          const rect = this.refs.node.getBoundingClientRect()\n          stop('VirtualListHeader gBCR')\n          this.store.setForRealm({ headerHeight: rect.height })\n        })\n      }\n    }\n  }\n</script>\n","<VirtualListContainer {realm} on:initialized on:noNeedToScroll >\n  <div class=\"virtual-list\"\n       style=\"height: {$height}px;\"\n       ref:node >\n    <VirtualListHeader component={headerComponent} virtualProps={headerProps} shown={$showHeader}/>\n    {#if $visibleItems}\n      {#each $visibleItems as visibleItem (visibleItem.key)}\n        <VirtualListLazyItem {component}\n                             offset={visibleItem.offset}\n                             {makeProps}\n                             key={visibleItem.key}\n                             index={visibleItem.index}\n        />\n      {/each}\n      {#if !$visibleItems.length}\n        <div class=\"nothing-to-show\">\n          Nothing to show.\n        </div>\n      {/if}\n    {/if}\n    {#if $showFooter}\n      <VirtualListFooter component={footerComponent} />\n    {/if}\n  </div>\n</VirtualListContainer>\n<style>\n  .virtual-list {\n    position: relative;\n    width: 100%;\n  }\n  .nothing-to-show {\n    font-size: 1.1em;\n    width: 100%;\n    padding: 20px 0;\n    text-align: center;\n  }\n</style>\n<script>\n  import VirtualListContainer from './VirtualListContainer.html'\n  import VirtualListLazyItem from './VirtualListLazyItem'\n  import VirtualListFooter from './VirtualListFooter.html'\n  import VirtualListHeader from './VirtualListHeader.html'\n  import { virtualListStore } from './virtualListStore'\n  import throttle from 'lodash-es/throttle'\n  import { mark, stop } from '../../_utils/marks'\n  import isEqual from 'lodash-es/isEqual'\n  import { observe } from 'svelte-extras'\n\n  const DISTANCE_FROM_BOTTOM_TO_FIRE = 800\n  const SCROLL_EVENT_THROTTLE = 1000\n\n  export default {\n    oncreate () {\n      this.fireScrollToBottom = throttle(() => {\n        this.fire('scrollToBottom')\n      }, SCROLL_EVENT_THROTTLE)\n      this.fireScrollToTop = throttle(() => {\n        this.fire('scrollToTop')\n      }, SCROLL_EVENT_THROTTLE)\n      this.observe('showFooter', showFooter => {\n        mark('set showFooter')\n        this.store.setForRealm({ showFooter: showFooter })\n        mark('set showFooter')\n      })\n      this.observe('showHeader', showHeader => {\n        mark('set showHeader')\n        this.store.setForRealm({ showHeader: showHeader })\n        stop('set showHeader')\n      })\n      this.observe('items', (newItems, oldItems) => {\n        if (!newItems || isEqual(newItems, oldItems)) {\n          return\n        }\n        mark('set items')\n        this.store.setForRealm({ items: newItems })\n        stop('set items')\n      })\n      // We observe on the component rather than the store to avoid a leak in store listeners\n      // (Svelte automatically removes component listeners, but not store listeners)\n      this.observe('allVisibleItemsHaveHeight', allVisibleItemsHaveHeight => {\n        this.calculateListOffset()\n        if (allVisibleItemsHaveHeight) {\n          this.fire('initializedVisibleItems')\n        }\n      })\n\n      this.observe('distanceFromBottom', (distanceFromBottom) => {\n        if (distanceFromBottom >= 0 &&\n            distanceFromBottom <= DISTANCE_FROM_BOTTOM_TO_FIRE) {\n          this.fireScrollToBottom()\n        }\n      }, { init: false })\n\n      this.observe('scrollTop', (scrollTop) => {\n        this.fire('scrollTopChanged', scrollTop)\n        if (scrollTop === 0) {\n          this.fireScrollToTop()\n        }\n        this.calculateListOffset()\n      })\n    },\n    data: () => ({\n      component: null\n    }),\n    store: () => virtualListStore,\n    components: {\n      VirtualListContainer,\n      VirtualListLazyItem,\n      VirtualListFooter,\n      VirtualListHeader\n    },\n    computed: {\n      distanceFromBottom: ({ $scrollHeight, $scrollTop, $offsetHeight }) => {\n        return $scrollHeight - $scrollTop - $offsetHeight\n      },\n      scrollTop: ({ $scrollTop }) => $scrollTop,\n      allVisibleItemsHaveHeight: ({ $allVisibleItemsHaveHeight }) => $allVisibleItemsHaveHeight,\n      visibleItemKeys: ({ $visibleItems }) => ($visibleItems || []).map(_ => _.key)\n    },\n    methods: {\n      observe,\n      calculateListOffset () {\n        // TODO: better way to get the offset top?\n        const node = this.refs.node\n        if (!node) {\n          return\n        }\n        mark('calculateListOffset')\n        const { offsetParent } = node\n        // TODO: offsetParent is null sometimes in testcafe tests\n        const listOffset = offsetParent ? offsetParent.offsetTop : 0\n        this.store.setForRealm({ listOffset })\n        stop('calculateListOffset')\n      }\n    }\n  }\n</script>\n","import { thunk } from '../thunk'\n\nexport const isMobile = thunk(() => process.browser && navigator.userAgent.match(/(?:iPhone|iPod|iPad|Android|KAIOS)/))\n"],"sourceRoot":""}