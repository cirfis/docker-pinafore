{"version":3,"file":"index.js","sources":["../dist-src/index.js"],"sourcesContent":["/**\n * Makes it so the left and right arrows change focus, ala Tab/Shift+Tab. This is mostly designed\n * for KaiOS devices.\n */\n/* global document, addEventListener, removeEventListener, getSelection */\n// TODO: email/number types are a special type, in that they return selectionStart/selectionEnd as null\n// As far as I can tell, there is no way to actually get the caret position from these inputs. So we\n// don't do the proper caret handling for those inputs, unfortunately.\n// https://html.spec.whatwg.org/multipage/input.html#do-not-apply\nvar textInputTypes = ['text', 'search', 'url', 'password', 'tel'];\nvar checkboxRadioInputTypes = ['checkbox', 'radio'];\nvar focusTrapTest = undefined;\n// This query is adapted from a11y-dialog\n// https://github.com/edenspiekermann/a11y-dialog/blob/cf4ed81/a11y-dialog.js#L6-L18\nvar focusablesQuery = 'a[href], area[href], input, select, textarea, ' +\n    'button, iframe, object, embed, [contenteditable], [tabindex], ' +\n    'video[controls], audio[controls], summary';\nfunction getActiveElement() {\n    var activeElement = document.activeElement;\n    while (activeElement.shadowRoot) {\n        activeElement = activeElement.shadowRoot.activeElement;\n    }\n    return activeElement;\n}\nfunction isFocusable(element) {\n    return element.matches(focusablesQuery) &&\n        !element.disabled &&\n        !/^-/.test(element.getAttribute('tabindex') || '') &&\n        !element.hasAttribute('inert') && // see https://github.com/GoogleChrome/inert-polyfill\n        (element.offsetWidth > 0 || element.offsetHeight > 0);\n}\nfunction getFocusTrapParent(element) {\n    if (!focusTrapTest) {\n        return;\n    }\n    var parent = element.parentElement;\n    while (parent) {\n        if (focusTrapTest(parent)) {\n            return parent;\n        }\n        parent = parent.parentElement;\n    }\n}\nfunction shouldIgnoreEvent(activeElement, forwardDirection) {\n    var tagName = activeElement.tagName;\n    var isTextarea = tagName === 'TEXTAREA';\n    var isTextInput = tagName === 'INPUT' &&\n        textInputTypes.indexOf(activeElement.getAttribute('type').toLowerCase()) !== -1;\n    var isContentEditable = activeElement.hasAttribute('contenteditable');\n    if (!isTextarea && !isTextInput && !isContentEditable) {\n        return false;\n    }\n    var selectionStart;\n    var selectionEnd;\n    var len;\n    if (isContentEditable) {\n        var selection = getSelection();\n        selectionStart = selection.anchorOffset;\n        selectionEnd = selection.focusOffset;\n        len = activeElement.textContent.length;\n    }\n    else {\n        selectionStart = activeElement.selectionStart;\n        selectionEnd = activeElement.selectionEnd;\n        len = activeElement.value.length;\n    }\n    // if the cursor is inside of a textarea/input, then don't focus to the next/previous element\n    // unless the cursor is at the beginning or the end\n    if (!forwardDirection && selectionStart === selectionEnd && selectionStart === 0) {\n        return false;\n    }\n    else if (forwardDirection && selectionStart === selectionEnd && selectionStart === len) {\n        return false;\n    }\n    return true;\n}\nfunction getNextCandidateNodeForShadowDomPolyfill(root, targetElement, forwardDirection, filter) {\n    // When the shadydom polyfill is running, we can't use TreeWalker on ShadowRoots because\n    // they aren't real Nodes. So we do this workaround where we run TreeWalker on the\n    // children instead.\n    var nodes = Array.prototype.slice.call(root.querySelectorAll('*'));\n    var idx = nodes.indexOf(targetElement);\n    if (forwardDirection) {\n        nodes = nodes.slice(idx + 1);\n    }\n    else {\n        if (idx === -1) {\n            idx = nodes.length;\n        }\n        nodes = nodes.slice(0, idx);\n        nodes.reverse();\n    }\n    for (var i = 0; i < nodes.length; i++) {\n        var node = nodes[i];\n        if (node instanceof HTMLElement && filter.acceptNode(node) === NodeFilter.FILTER_ACCEPT) {\n            return node;\n        }\n    }\n    return undefined;\n}\nfunction getNextCandidateNode(root, targetElement, forwardDirection, filter) {\n    var walker = document.createTreeWalker(root, NodeFilter.SHOW_ELEMENT, filter);\n    if (targetElement) {\n        walker.currentNode = targetElement;\n    }\n    if (forwardDirection) {\n        return walker.nextNode();\n    }\n    else if (targetElement) {\n        return walker.previousNode();\n    }\n    // iterating backwards through shadow root, use last child\n    return walker.lastChild();\n}\nfunction isShadowDomPolyfill() {\n    return typeof ShadowRoot !== 'undefined' &&\n        // ShadowRoot.polyfill is just a hack for our unit tests\n        ('polyfill' in ShadowRoot || !ShadowRoot.toString().includes('[native code]'));\n}\nfunction getNextNode(root, targetElement, forwardDirection) {\n    var filter = {\n        acceptNode: function (node) {\n            return (node === targetElement || node.shadowRoot || isFocusable(node))\n                ? NodeFilter.FILTER_ACCEPT\n                : NodeFilter.FILTER_SKIP;\n        }\n    };\n    // TODO: remove this when we don't need to support the Shadow DOM polyfill\n    var nextNode = isShadowDomPolyfill() && root instanceof ShadowRoot\n        ? getNextCandidateNodeForShadowDomPolyfill(root, targetElement, forwardDirection, filter)\n        : getNextCandidateNode(root, targetElement, forwardDirection, filter);\n    if (nextNode && nextNode.shadowRoot) { // push into the shadow DOM\n        return getNextNode(nextNode.shadowRoot, null, forwardDirection);\n    }\n    if (!nextNode && root.host) { // pop out of the shadow DOM\n        return getNextNode(root.host.getRootNode(), root.host, forwardDirection);\n    }\n    return nextNode;\n}\nfunction focusNextOrPrevious(event, key) {\n    var activeElement = getActiveElement();\n    var forwardDirection = key === 'ArrowRight';\n    if (shouldIgnoreEvent(activeElement, forwardDirection)) {\n        return;\n    }\n    var root = getFocusTrapParent(activeElement) || activeElement.getRootNode();\n    var nextNode = getNextNode(root, activeElement, forwardDirection);\n    if (nextNode && nextNode !== activeElement) {\n        nextNode.focus();\n        event.preventDefault();\n    }\n}\nfunction handleEnter(event) {\n    var activeElement = getActiveElement();\n    if (activeElement.tagName === 'INPUT' &&\n        checkboxRadioInputTypes.indexOf(activeElement.getAttribute('type').toLowerCase()) !== -1) {\n        // Explicitly override \"enter\" on an input and make it fire the checkbox/radio\n        activeElement.click();\n        event.preventDefault();\n    }\n}\nfunction keyListener(event) {\n    if (event.altKey || event.metaKey || event.ctrlKey) {\n        return; // ignore e.g. Alt-Left and Ctrl-Right, which are used to switch browser tabs or navigate back/forward\n    }\n    var key = event.key;\n    switch (key) {\n        case 'ArrowLeft':\n        case 'ArrowRight': {\n            focusNextOrPrevious(event, key);\n            break;\n        }\n        case 'Enter': {\n            handleEnter(event);\n            break;\n        }\n    }\n}\n/**\n * Start listening for keyboard events. Attaches a listener to the window.\n */\nfunction register() {\n    addEventListener('keydown', keyListener);\n}\n/**\n * Stop listening for keyboard events. Unattaches a listener to the window.\n */\nfunction unregister() {\n    removeEventListener('keydown', keyListener);\n}\n/**\n * Set a focus trap test to identify any focus traps in the DOM, i.e. a top-level DOM node that indicates the root\n * of a focus trap. Once this is set, if focus changes within the focus trap, then will not leave the focus trap.\n * @param test: the test function\n * @see https://w3c.github.io/aria-practices/examples/dialog-modal/dialog.html\n */\nfunction setFocusTrapTest(test) {\n    focusTrapTest = test;\n}\nexport { register, unregister, setFocusTrapTest };\n"],"names":["textInputTypes","checkboxRadioInputTypes","focusTrapTest","undefined","focusablesQuery","getActiveElement","activeElement","document","shadowRoot","isFocusable","element","matches","disabled","test","getAttribute","hasAttribute","offsetWidth","offsetHeight","getFocusTrapParent","parent","parentElement","shouldIgnoreEvent","forwardDirection","tagName","isTextarea","isTextInput","indexOf","toLowerCase","isContentEditable","selectionStart","selectionEnd","len","selection","getSelection","anchorOffset","focusOffset","textContent","length","value","getNextCandidateNodeForShadowDomPolyfill","root","targetElement","filter","nodes","Array","prototype","slice","call","querySelectorAll","idx","reverse","i","node","HTMLElement","acceptNode","NodeFilter","FILTER_ACCEPT","getNextCandidateNode","walker","createTreeWalker","SHOW_ELEMENT","currentNode","nextNode","previousNode","lastChild","isShadowDomPolyfill","ShadowRoot","toString","includes","getNextNode","FILTER_SKIP","host","getRootNode","focusNextOrPrevious","event","key","focus","preventDefault","handleEnter","click","keyListener","altKey","metaKey","ctrlKey","register","addEventListener","unregister","removeEventListener","setFocusTrapTest"],"mappings":"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"}